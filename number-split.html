<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Maureen's Math Game</title>

<!-- ==========  Styles  ========== -->
<style>
@font-face{
  font-family:"Caveat";
  font-weight:400;
  src:url(data:font/woff2;base64,d09GMgABAAAAACPIAADrAAAAABuAAAAP8AAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHEIGVgCDH...) format('woff2');
}
:root{
  --bg:#FFF7E8;--orange:#e67e22;--orangeDark:#d35400;
  --blue:#3498db;--blueDark:#2980b9;
}
body{
  max-width:640px;margin:auto;padding:1rem;background:var(--bg);
  font-family:"Caveat","Comic Sans MS","Baloo","-apple-system",sans-serif;
  font-size:20px;line-height:1.5;color:#333;
}
header{text-align:center;margin-bottom:1rem}
h1{font-size:2.2rem;color:var(--orange);margin-bottom:.25rem}
h2{font-size:1.3rem;color:#555;margin-bottom:.6rem}
#todayStats{font-size:.9rem;color:#2c3e50;margin-bottom:1rem}

/* Config panel */
#config{
  background:#fff;padding:1rem;border-radius:10px;margin-bottom:1rem;
  display:flex;flex-wrap:wrap;gap:.8rem;align-items:center;justify-content:center;
  box-shadow:0 2px 4px rgba(0,0,0,.06)
}
#config label{display:flex;flex-direction:column;font-size:.9rem}
#config input{
  width:80px;padding:.25rem .5rem;margin-top:.25rem;
  border:2px solid #ccc;border-radius:6px;font-size:1rem;font-family:inherit;
}
button{
  cursor:pointer;font-family:inherit;font-size:1rem;border:none;border-radius:8px;
  box-shadow:0 2px 4px rgba(0,0,0,.15)
}
#generateBtn{padding:.55rem 1.4rem;background:var(--blue);color:#fff}
#generateBtn:hover{background:var(--blueDark)}
#submitBtn{
  position:fixed;left:50%;transform:translateX(-50%);bottom:18px;
  padding:.8rem 2.4rem;background:var(--orange);color:#fff;border-radius:40px;
  font-size:1.2rem;box-shadow:0 4px 8px rgba(0,0,0,.15)
}
#submitBtn:hover{background:var(--orangeDark)}
.hidden{display:none!important}

/* Progress bar */
#progress{height:10px;background:#ddd;border-radius:5px;overflow:hidden;margin-bottom:1rem}
#progressBar{height:100%;width:100%;background:#2ecc71;transition:width .2s linear}

/* Questions */
#questionList{list-style:none;padding-left:0;margin-bottom:6rem;
  display:flex;flex-direction:column;gap:1rem}
.question{font-size:1.5rem;display:flex;align-items:center;gap:.4rem;flex-wrap:wrap}
.question input{
  width:90px;text-align:center;padding:.3rem;
  border:2px solid #ccc;border-radius:8px;background:#fff;
  font-size:1.4rem
}
.timeSpan{font-size:.75rem;color:#888;margin-left:auto}
.longest .timeSpan{color:#e74c3c;font-weight:bold}
.missing input{background:#ffe7e7}
.wrong   input{background:#ffe7e7;border-color:#e74c3c;color:#d10000}

/* Dialog */
.dialog{position:fixed;inset:0;background:rgba(0,0,0,.35);
  display:flex;align-items:center;justify-content:center;z-index:1000}
.dialogContent{
  background:#fff;padding:2rem;border-radius:16px;max-width:90%;text-align:center;
  animation:pop .4s ease-out;box-shadow:0 8px 16px rgba(0,0,0,.2)
}
@keyframes pop{0%{transform:scale(.6);opacity:0}100%{transform:scale(1);opacity:1}}
.dialogContent h3{font-size:2rem;color:#27ae60;margin-bottom:.6rem}
.dialogContent p {font-size:1.1rem;margin-bottom:1.2rem}
.dialogContent button{
  padding:.6rem 1.6rem;background:var(--blue);color:#fff;border-radius:8px;
}
.dialogContent button:hover{background:var(--blueDark)}

/* Emoji rain */
@keyframes fall{0%{transform:translateY(-10vh) rotate(0);opacity:1}
                100%{transform:translateY(110vh) rotate(360deg);opacity:0}}
.faller{position:fixed;top:-10vh;font-size:2rem;pointer-events:none;animation:fall 6s linear forwards}
</style>
</head>

<body>
<header>
  <h1>Maureen's Math Game</h1>
  <h2>2. å‡‘æ•°å¤§æŒ‘æˆ˜</h2>
  <div id="todayStats">Loadingâ€¦</div>
</header>

<section id="config">
  <label id="lblTarget"></label>
  <input id="targetNumber" type="number" min="2" max="50" value="10">
  <label id="lblTime"></label>
  <input id="timeLimit" type="number" min="30" max="180" value="90">
  <button id="generateBtn"></button>
</section>

<section id="quizArea" class="hidden">
  <div id="progress"><div id="progressBar"></div></div>
  <ol id="questionList"></ol>
</section>

<button id="submitBtn" class="hidden"></button>

<div id="resultDialog" class="dialog hidden">
  <div class="dialogContent">
    <h3 id="resultTitle"></h3>
    <p id="resultDetails"></p>
    <button id="closeDialog"></button>
  </div>
</div>

<!-- ==========  Script  ========== -->
<script>
(()=>{
'use strict';

/* ---------- i18n ---------- */
const dict={
  en:{target:'Target Number',time:'Time Limit (s)',gen:'Generate',sub:'Submit',
      stats:(c,b)=>`Today: ${c} ï½œ Best ${b}`,
      few:n=>`Only ${n} unique splits.`,
      perfect:'Perfect!',allRight:'All correct!',overtime:s=>`Overtime ${s}s`,
      score:s=>`Score ${s}`,timeTxt:s=>`Time ${s}s`,ok:'Okay'},
  zh:{target:'æ‹†åˆ†ç›®æ ‡æ•°',time:'æ—¶é—´é™åˆ¶ (ç§’)',gen:'ç”Ÿæˆé¢˜ç›®',sub:'äº¤å·',
      stats:(c,b)=>`ä»Šæ—¥å·²ç»ƒä¹  ${c} æ¬¡ ï½œ æœ€é«˜ ${b}`,
      few:n=>`å”¯ä¸€æ‹†åˆ†ä»… ${n} ç§ï¼Œé¢˜é‡å·²å‡å°‘ã€‚`,
      perfect:'æ»¡åˆ†ï¼å¤ªæ£’å•¦ï¼',allRight:'å…¨å¯¹ï¼å†å¿«ä¸€ç‚¹ï¼',overtime:s=>`è¶…æ—¶ ${s}s`,
      score:s=>`æœ¬æ¬¡å¾—åˆ†ï¼š${s}`,timeTxt:s=>`ç”¨æ—¶ ${s}s`,ok:'çŸ¥é“å•¦'}
};
const lang=navigator.language?.toLowerCase().startsWith('zh')?'zh':'en';
const t=dict[lang];

/* ---------- DOM refs ---------- */
const $=id=>document.getElementById(id);
$('lblTarget').innerText=t.target;
$('lblTime').innerText =t.time;
$('generateBtn').innerText=t.gen;
$('submitBtn').innerText  =t.sub;
$('closeDialog').innerText=t.ok;

/* ---------- Utils ---------- */
const randInt=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const shuffle=a=>{for(let i=a.length-1;i>0;i--){const j=randInt(0,i);[a[i],a[j]]=[a[j],a[i]];}return a;};
const todayKey=()=>new Date().toISOString().slice(0,10);

/* ---------- Stats ---------- */
let store=JSON.parse(localStorage.getItem('nsc')||'{}');
let dateKey=todayKey(); if(!store[dateKey])store[dateKey]={count:0,best:0};
const updateStats=()=>{$('todayStats').innerText=t.stats(store[dateKey].count,store[dateKey].best);};
updateStats();

/* ---------- State ---------- */
let timer=null,rainTimer=null,startTime=0,timeLeft=0,qTimes=[],curIdx=null,focusStart=null;
const animals=['ðŸ¦«','ðŸ°','ðŸ±','ðŸ¶','ðŸ¼','ðŸµ','ðŸ¦Š','ðŸ¦','ðŸ¦”','ðŸ¢','ðŸ¦„','ðŸ§','ðŸ¦‰'];

/* ---------- Functions ---------- */
const stopRain=()=>{if(rainTimer)clearInterval(rainTimer);document.querySelectorAll('.faller').forEach(el=>el.remove());};

const startRain=emoji=>{
  stopRain();
  rainTimer=setInterval(()=>{
    const e=document.createElement('span');
    e.className='faller';e.textContent=emoji;
    e.style.left=Math.random()*100+'vw';
    e.style.fontSize=(1+Math.random()*2)+'rem';
    e.style.animationDuration=(5+Math.random()*3)+'s';
    document.body.appendChild(e);setTimeout(()=>e.remove(),8000);
  },250);
};

function generate(){
  dateKey=todayKey(); if(!store[dateKey])store[dateKey]={count:0,best:0}; updateStats();
  stopRain(); if(timer)clearInterval(timer);

  const target=Math.max(2,+$('targetNumber').value||10),
        limit =+$('timeLimit').value||90;

  let blanks=shuffle([...Array(target+1).keys()]).slice(0,Math.min(10,target+1));
  if(blanks.length<10)alert(t.few(blanks.length));

  const list=$('questionList');list.innerHTML='';
  blanks.forEach((b,i)=>{
    const li=document.createElement('li');li.className='question';
    li.innerHTML=`<input type="number" class="ans" data-i="${i}" data-ans="${b}"> + ${target-b} = ${target} <span class="timeSpan"></span>`;
    list.appendChild(li);
  });

  /* focus tracking */
  qTimes=new Array(blanks.length);
  list.querySelectorAll('.ans').forEach(inp=>{
    inp.onfocus=()=>{
      const idx=+inp.dataset.i,now=Date.now();
      if(curIdx!==null)qTimes[curIdx]=(qTimes[curIdx]||0)+now-focusStart;
      curIdx=idx;focusStart=now;
    };
  });

  $('quizArea').classList.remove('hidden');
  $('submitBtn').classList.remove('hidden');
  $('resultDialog').classList.add('hidden');

  /* timer */
  timeLeft=limit;startTime=Date.now();
  $('progressBar').style.width='100%';$('progressBar').style.background='#2ecc71';
  timer=setInterval(()=>{
    timeLeft--;const pct=timeLeft/limit*100;
    $('progressBar').style.width=pct+'%';
    $('progressBar').style.background=pct<30?'#e74c3c':(pct<60?'#f1c40f':'#2ecc71');
    if(timeLeft<=0){clearInterval(timer);grade();}
  },1000);
}

function grade(){
  if(timer)clearInterval(timer);if(curIdx!==null)qTimes[curIdx]+=Date.now()-focusStart;

  let score=0,all=true;
  document.querySelectorAll('.ans').forEach(inp=>{
    const idx=+inp.dataset.i,need=+inp.dataset.ans,val=+inp.value;
    if(val===need)score+=10; else{all=false;if(inp.value!=='')inp.parentNode.classList.add('wrong');}
    if(inp.value==='')inp.parentNode.classList.add('missing');
    inp.disabled=true;const t=qTimes[idx]||0;
    inp.parentNode.querySelector('.timeSpan').textContent=` (${(t/1000).toFixed(1)}s)`;
  });
  const slowIdx=qTimes.indexOf(Math.max(...qTimes.map(x=>x||0)));
  if(slowIdx>=0)$('questionList').children[slowIdx].classList.add('longest');

  /* stats */
  store[dateKey].count++;if(score>store[dateKey].best)store[dateKey].best=score;
  localStorage.setItem('nsc',JSON.stringify(store));updateStats();

  const used=((Date.now()-startTime)/1000).toFixed(1),
        over=Math.max(0,used-+$('timeLimit').value).toFixed(1);
  let emoji='â­';
  if(all&&over==0){$('resultTitle').innerText=t.perfect;$('resultDetails').innerText=t.timeTxt(used);emoji=animals[randInt(0,animals.length-1)];}
  else if(all){$('resultTitle').innerText=t.allRight;$('resultDetails').innerText=`${t.overtime(over)} ï½œ ${t.score(score)}`;}
  else{$('resultTitle').innerText=t.score(score);$('resultDetails').innerText=t.timeTxt(used);}
  $('resultDialog').classList.remove('hidden');$('submitBtn').classList.add('hidden');
  startRain(emoji);
}

/* ---------- Event bindings ---------- */
$('generateBtn').onclick=generate;
$('submitBtn').onclick=grade;
$('closeDialog').onclick=()=>$('resultDialog').classList.add('hidden');

/* Init stats text */
updateStats();
})();
</script>
</body>
</html>
