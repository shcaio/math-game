<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>口算小挑战</title>
  <style>
    :root{--bg:#FFF7E8;--orange:#e67e22;--orangeDark:#d35400;--blue:#3498db;--blueDark:#2980b9;}
    body{max-width:680px;margin:auto;padding:1rem;background:var(--bg);font-family:"Caveat","Comic Sans MS","Baloo","Chalkboard","-apple-system",sans-serif;line-height:1.5;color:#333;font-size:20px;}
    header{text-align:center;margin-bottom:1rem}
    h1{font-size:2.0rem;color:var(--orange);margin-bottom:.25rem}
    h2{font-size:1.1rem;color:#555;margin-top:0.5rem;margin-bottom:.6rem}
    #todayStats{font-size:.9rem;color:#2c3e50;margin-bottom:1rem}
    #config{background:#fff;padding:0.8rem 1rem;border-radius:10px;margin-bottom:1rem;display:flex;align-items:center;justify-content:flex-start;gap:1rem;box-shadow:0 2px 4px rgba(0,0,0,.05);flex-wrap:wrap}
    #config label{font-size:1rem;color:#37474f;display:flex;align-items:center;gap:.35rem}
    #config .ops{display:flex;align-items:center;gap:.8rem;margin-right:.4rem}
    #config input[type="number"]{width:72px;padding:.35rem;border:2px solid #ccc;border-radius:6px;font-size:1rem;margin-left:.35rem}
    #config input[type="checkbox"]{width:auto}
    #genBtn{padding:.5rem 1rem;background:var(--blue);color:#fff;border:none;border-radius:6px;font-size:1rem;cursor:pointer}
    #genBtn:hover{background:var(--blueDark)}
    #progress{height:10px;background:#ddd;border-radius:5px;overflow:hidden;margin:1rem 0}
    #progressBar{width:100%;height:100%;background:#2ecc71;transition:width .2s linear}
    #questionList{list-style:none;padding:0;margin-bottom:6rem;}
    .question{font-size:1.6rem;margin:.9em auto;color:#000;}
    .question .main{white-space:nowrap;overflow-x:auto;-webkit-overflow-scrolling:touch;}
    .question input{width:3.2em;font-size:1.1rem;text-align:center;border:2px solid #aaa;border-radius:5px;background:#fffbea;margin:0 6px}
    .tag{font-size:.85rem;color:#888;margin-right:.4rem}
    .correct{background:#c8e6c9!important}
    .wrong{background:#ffcdd2!important}
    #submitBtn{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);padding:.6rem 1.4rem;background:var(--orange);color:#fff;border:none;border-radius:40px;font-size:1.1rem;cursor:pointer;box-shadow:0 4px 8px rgba(0,0,0,.1)}
    #submitBtn:hover{background:var(--orangeDark)}
    .dialog{position:fixed;inset:0;background:rgba(0,0,0,.3);display:flex;align-items:center;justify-content:center;z-index:1000}
    .hidden{display:none!important}
    .dialogContent{background:#fff;padding:2rem;border-radius:12px;text-align:center;box-shadow:0 8px 16px rgba(0,0,0,.2);animation:pop .3s ease-out}
    @keyframes pop{from{transform:scale(.7);opacity:0}to{transform:scale(1);opacity:1}}
    .dialogContent h3{font-size:1.8rem;color:#27ae60;margin-bottom:.8rem}
    .dialogContent p{font-size:1.05rem;margin-bottom:1.1rem}
    .dialogContent button{padding:.6rem 1.5rem;background:var(--blue);color:#fff;border:none;border-radius:6px;font-size:1rem;cursor:pointer}
    .dialogContent button:hover{background:var(--blueDark)}
    @keyframes fall{0%{transform:translateY(-15vh) rotate(0);opacity:1}100%{transform:translateY(110vh) rotate(360deg);opacity:0}}
    .faller{position:fixed;top:-15vh;font-size:2rem;pointer-events:none;animation:fall 6s linear forwards}
  </style>
</head>
<body>
<header>
  <h1>Maureen's Math Game</h1>
  <h2>10~20 口算大挑战</h2>
  <div id="todayStats">今日已练习 <span id="playCount">0</span> 次 ｜ 最高 <span id="highScore">0</span></div>
</header>

<div id="config">
  <div class="ops">
    <label><input id="chkAdd" type="checkbox" checked /> 加法</label>
    <label><input id="chkSub" type="checkbox" /> 减法</label>
  </div>
  <label>⏱ 时间限制(秒)
    <input id="timeLimit" type="number" value="200" />
  </label>
  <button id="genBtn">生成题目</button>
</div>

<div id="progress"><div id="progressBar"></div></div>
<ol id="questionList"></ol>
<button id="submitBtn" class="hidden">交卷</button>

<div id="resultDialog" class="dialog hidden">
  <div class="dialogContent">
    <h3 id="resultTitle"></h3>
    <p id="resultDetails"></p>
    <button id="closeDialog">知道啦</button>
  </div>
</div>

<script>
(() => {
  const $ = id => document.getElementById(id);

  // ======= 统计 =======
  const dateKey = new Date().toISOString().slice(0,10);
  let store = JSON.parse(localStorage.getItem('splitStats') || '{}');
  if (!store[dateKey]) store[dateKey] = { count: 0, best: 0 };
  function updateStats(){
    $('playCount').textContent = store[dateKey].count;
    $('highScore').textContent = store[dateKey].best;
    localStorage.setItem('splitStats', JSON.stringify(store));
  }
  updateStats();

  // ======= 工具 =======
  const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

  // ======= 雨动画 =======
  let rainTimer;
  function stopRain(){
    clearInterval(rainTimer);
    document.querySelectorAll('.faller').forEach(el => el.remove());
  }
  function startRain(pool){
    stopRain();
    const emojies = pool.slice().sort(()=>Math.random()-0.5);
    rainTimer = setInterval(()=>{
      const e = document.createElement('span');
      e.className = 'faller';
      e.textContent = emojies[Math.floor(Math.random()*emojies.length)];
      e.style.left = Math.random()*100 + 'vw';
      e.style.fontSize = (1.6 + Math.random()*1.1) + 'rem';
      e.style.animationDuration = (4 + Math.random()*4) + 's';
      document.body.appendChild(e);
      setTimeout(()=> e.remove(), 9000);
    }, 220 + Math.random()*220);
  }

  // ======= 题型生成 =======
  function genA1(){
    // a,b∈1..9，总和 11..20
    let a, b, s;
    do {
      a = randInt(1,9);
      b = randInt(1, Math.min(9, 20-a));
      s = a + b;
    } while (s < 11 || s > 20);
    return { key: `A:${a}+${b}`, text: `${a} + ${b} =`, ans: s, tag: 'a1' };
  }
  function genA2(){
    // 有一个数 ≥10，另一个数 1..9；总和在 11..20
    let big, small, s;
    do {
      big = randInt(10, 19);
      small = randInt(1,9);
      s = big + small;
    } while (s < 11 || s > 20);
    // 随机把 big 放前或后
    if (Math.random() < 0.5) return { key:`A:${big}+${small}`, text:`${big} + ${small} =`, ans:s, tag:'a2' };
    else return { key:`A:${small}+${big}`, text:`${small} + ${big} =`, ans:s, tag:'a2' };
  }

  function genD1(){
    // 被减数 m∈11..20；减数 s <10；答案 r <10（严格小于10），且 r>=1
    // 构造法：选 m，再选 r∈[max(1,m-9)..min(9,m-1)]，令 s=m-r；保证 s,r 都在 1..9
    let m, r, s;
    do {
      m = randInt(11,20);
      const rMin = Math.max(1, m - 9);
      const rMax = Math.min(9, m - 1);
      if (rMin > rMax) continue; // 保险
      r = randInt(rMin, rMax);   // r < 10
      s = m - r;                 // s < 10
    } while (!(s >= 1 && s < 10 && r >= 1 && r < 10));
    return { key: `D:${m}-${s}`, text: `${m} − ${s} =`, ans: r, tag: 'd1' };
  }

  function genD2(){
    // 被减数 m∈11..20；且“减数≥10 或 答案≥10”
    let m, s, r;
    do {
      m = randInt(11,20);
      if (Math.random() < 0.5) {
        // 先定 r≥10
        const rMin = 10;
        const rMax = m - 1;
        if (rMin > rMax) continue;
        r = randInt(rMin, rMax);
        s = m - r; // s in 1..10
      } else {
        // 先定 s≥10
        const sMin = 10;
        const sMax = m - 1;
        if (sMin > sMax) continue;
        s = randInt(sMin, sMax);
        r = m - s; // r in 1..10
      }
    } while (!(s >= 1 && s <= m-1 && r >= 1));
    return { key: `D:${m}-${s}`, text: `${m} − ${s} =`, ans: r, tag: 'd2' };
  }

  function buildSet(count, genFn, seen){
    const arr = [];
    let guard = 0;
    while (arr.length < count && guard++ < 1000){
      const p = genFn();
      if (!seen.has(p.key)){
        seen.add(p.key);
        arr.push(p);
      }
    }
    return arr;
  }

  // ======= 渲染与判卷 =======
  let timer, startTime;
  function renderQuestions(){
    stopRain();
    $('resultDialog').classList.add('hidden');
    $('submitBtn').classList.add('hidden');
    const list = $('questionList'); list.innerHTML = '';

    // 计时
    clearInterval(timer);
    const limit = +$('timeLimit').value || 200;
    let rem = limit; startTime = Date.now();
    $('progressBar').style.width = '100%';
    timer = setInterval(()=>{
      rem--;
      $('progressBar').style.width = (rem/limit*100) + '%';
      if (rem<=0) clearInterval(timer);
    }, 1000);

    // 题目选择
    const useAdd = $('chkAdd').checked;
    const useSub = $('chkSub').checked;
    const seen = new Set();
    let problems = [];

    if (useAdd && !useSub){
      problems = problems.concat(buildSet(7, genA1, seen), buildSet(3, genA2, seen));
    } else if (!useAdd && useSub){
      problems = problems.concat(buildSet(7, genD1, seen), buildSet(3, genD2, seen));
    } else { // both
      problems = problems.concat(buildSet(4, genA1, seen), buildSet(1, genA2, seen),
                                 buildSet(4, genD1, seen), buildSet(1, genD2, seen));
    }

    // 渲染
    for (const p of problems){
      const li = document.createElement('li');
      li.className = 'question';
      const tagLabel = (p.tag==='a2'||p.tag==='d2') ? '<span class="tag">【进阶】</span>' : '';
      li.innerHTML = `<div class="main">${tagLabel}${p.text}
        <input type="text" inputmode="numeric" pattern="\\d*" data-ans="${p.ans}" />
      </div>`;
      list.appendChild(li);
    }

    // 自动聚焦第一题
    setTimeout(()=>{
      const first = list.querySelector('input[data-ans]');
      if (first) first.focus();
    }, 50);

    $('submitBtn').classList.remove('hidden');
  }

  function grade(){
    clearInterval(timer);
    const elapsed = (Date.now()-startTime)/1000;
    const withinTime = elapsed <= (+$('timeLimit').value || 200);
    let correct = 0, totalInputs = 0;
    document.querySelectorAll('input[data-ans]').forEach(inp=>{
      totalInputs++;
      const ans = +inp.dataset.ans;
      const val = +inp.value;
      inp.classList.remove('correct','wrong');
      if (val === ans){ inp.classList.add('correct'); correct++; }
      else { inp.classList.add('wrong'); }
    });
    const score = Math.round(correct/totalInputs*100);

    // 更新统计
    store[dateKey].count++;
    if (score > store[dateKey].best) store[dateKey].best = score;
    updateStats();

    // 三档下雨
    const goodPool = ['🎉','🦊','🐱','🐶','🐼','🦄','🐧','🦉','🦝','🦔','🐢','⭐','🌟','✨'];
    const starPool = ['⭐','🌟','✨'];
    const poopPool = ['💩','💩','💩','💩'];

    let msg;
    if (correct === totalInputs && withinTime){
      msg = '限时内全对！太棒啦！';
      startRain(goodPool);
    } else if ((correct < totalInputs && withinTime) || (correct === totalInputs && !withinTime)){
      msg = (correct === totalInputs) ? `全对但超时 ${elapsed.toFixed(1)}s` : `用时 ${elapsed.toFixed(1)}s，有错哦，要加油~`;
      startRain(starPool);
    } else {
      msg = `超时 ${elapsed.toFixed(1)}s，要加油哦，再来一遍！`;
      startRain(poopPool);
    }

    $('resultTitle').textContent = (score===100) ? '满分！太棒啦！' : `得分：${score}`;
    $('resultDetails').textContent = msg;
    $('resultDialog').classList.remove('hidden');
  }

  // 事件
  $('genBtn').addEventListener('click', renderQuestions);
  $('submitBtn').addEventListener('click', grade);
  $('closeDialog').addEventListener('click', ()=> $('resultDialog').classList.add('hidden'));
})();
</script>
</body>
</html>
